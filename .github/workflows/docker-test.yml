name: Docker Compose Test

on:
  pull_request:
    branches:
      - master
      - main
  push:
    branches:
      - master
      - main

jobs:
  docker-test:
    name: Test Docker Compose Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      localstack:
        image: localstack/localstack:3.0.2
        ports:
          - 4566:4566
        env:
          SERVICES: s3
          DEBUG: 0
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install

      - name: Configure AWS credentials for LocalStack
        run: |
          aws configure set aws_access_key_id test
          aws configure set aws_secret_access_key test
          aws configure set default.region us-east-1

      - name: Wait for LocalStack and create S3 bucket
        run: |
          echo "Waiting for LocalStack to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:4566/_localstack/health 2>/dev/null; then
              echo "✓ LocalStack is healthy"
              break
            fi
            echo "Waiting... attempt $i/30"
            sleep 2
          done

          echo "Creating S3 bucket..."
          aws --endpoint-url=http://localhost:4566 s3 mb s3://test-bucket
          aws --endpoint-url=http://localhost:4566 s3 ls
          echo "✓ S3 bucket created successfully"

      - name: Create rclone.conf for testing
        run: |
          cat > rclone.conf << 'EOF'
          [s3-local]
          type = s3
          provider = Other
          access_key_id = test
          secret_access_key = test
          endpoint = http://localhost:4566
          force_path_style = true
          EOF

      - name: Create test-data directory
        run: mkdir -p test-data

      - name: Start Rclone daemon in background
        run: |
          docker run -d \
            --name rclone-daemon \
            --network host \
            -v $(pwd)/rclone.conf:/config/rclone/rclone.conf:ro \
            -v $(pwd)/test-data:/data \
            -e RCLONE_CONFIG=/config/rclone/rclone.conf \
            rclone/rclone:latest \
            rcd --rc-addr :5572 --rc-user admin --rc-pass password --rc-allow-origin "*" --log-level INFO

      - name: Wait for Rclone to be ready
        run: |
          echo "Waiting for Rclone daemon..."
          for i in {1..30}; do
            if curl -f -u admin:password http://localhost:5572/core/version 2>/dev/null; then
              echo "✓ Rclone is ready"
              exit 0
            fi
            echo "Waiting... attempt $i/30"
            sleep 2
          done
          echo "✗ Rclone failed to start"
          docker logs rclone-daemon
          exit 1

      - name: Test Rclone API
        run: |
          echo "Testing Rclone API..."
          curl -u admin:password http://localhost:5572/core/version | jq .

      - name: Build WebUI Docker image
        run: docker build -t rclone-webui:test .

      - name: Start WebUI container
        run: |
          docker run -d \
            --name rclone-webui \
            --network host \
            -e RCLONE_URL=http://localhost:5572 \
            rclone-webui:test

      - name: Wait for WebUI to be ready
        run: |
          echo "Waiting for WebUI..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "✓ WebUI is ready"
              exit 0
            fi
            echo "Waiting... attempt $i/30"
            sleep 2
          done
          echo "✗ WebUI failed to start"
          docker logs rclone-webui
          exit 1

      - name: Test WebUI accessibility
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
          echo "WebUI returned HTTP $response"
          if [ "$response" = "200" ]; then
            echo "✓ WebUI is accessible"
          else
            echo "✗ WebUI check failed"
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Rclone logs ==="
          docker logs rclone-daemon || true
          echo ""
          echo "=== WebUI logs ==="
          docker logs rclone-webui || true

      - name: Clean up containers
        if: always()
        run: |
          docker stop rclone-daemon rclone-webui || true
          docker rm rclone-daemon rclone-webui || true
