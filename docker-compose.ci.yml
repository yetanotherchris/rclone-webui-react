# Docker Compose override for CI environments (GitHub Actions)
# This file simplifies the LocalStack configuration for CI

services:
  # Override localstack for CI - simplified configuration with stable version
  localstack:
    image: localstack/localstack:3.0.2
    environment:
      - SERVICES=s3
      - DEBUG=0
      - DISABLE_CORS_CHECKS=1
      - SKIP_SSL_CERT_DOWNLOAD=1
      - EAGER_SERVICE_LOADING=1
      - LOCALSTACK_HOST=localhost:4566
    # Override volume mount to use tmpfs (/dev/shm) instead of ./localstack-data
    # This prevents "device busy" errors when LocalStack tries to clean /tmp/localstack
    volumes:
      - /dev/shm:/tmp/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 15s

  # Override rclone to remove healthcheck dependency
  rclone:
    depends_on:
      - localstack

  # Override init-s3 to remove healthcheck dependency
  init-s3:
    depends_on:
      - localstack
    command:
      - -c
      - |
        echo "Waiting for localstack to be fully ready..."
        for i in {1..30}; do
          if aws --endpoint-url=http://localstack:4566 s3 ls 2>/dev/null; then
            echo "LocalStack S3 is ready"
            break
          fi
          echo "Waiting for LocalStack S3... attempt $i/30"
          sleep 2
        done
        echo "Creating S3 bucket..."
        aws --endpoint-url=http://localstack:4566 s3 mb s3://test-bucket || true
        aws --endpoint-url=http://localstack:4566 s3api put-object --bucket test-bucket --key photos/ || true
        aws --endpoint-url=http://localstack:4566 s3api put-object --bucket test-bucket --key documents/ || true
        echo "S3 bucket initialized successfully"


